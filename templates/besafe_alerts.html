{% extends 'base.html' %}
{% block title %}BeSafe Check-In/Alert Page{% endblock %}
{% block head %}	
{% endblock %}
{% block content %}
<h1 class="centered_text">BeSafe Warning System Scheduler Page</h1>
<div style="text-align: center"> <h2>Your Local Time: &nbsp <div id='clock'></div></h2></div>
<div class = "centered">


<!--#########################################-->
<!--In Progress Check-in Redesign-->
{% for al in alerts %}


<div class="check-in-div" id="alertDiv{{ al.alert_id }}" style="border-style: solid;">
	<div class="col-8" style="display: inline-block;">
		<p class="centered_text" style="display: inline-block;">Check-In: {{ al.a_name }}</p>
		<div class="col-2" id="alert_inner" style="display: inline-block;"> 
			<input id="toggle_rec{{ al.alert_id }}" type="checkbox" data-toggle="toggle" class="display_toggle" data-on="Alert Set Active" data-off="Inactive" {% if al.active == True %}checked{% endif %} name="{{ al.alert_id }}">
		</div>
	</div>
	<p>Status:{% if al.active == true %} Currently Active {% else %} Currently Innactive {% endif %} </p>
	{% if al.active == true %} <p>Checked in {{ al.checked_in }} Times so Far</p> {% endif %}
	<p id="datetime{{ al.alert_id }}">Scheduled Check-In Time: {{ al.next_alarm_dis }}</p>
	{% if al.active == true %}
	<div class="countdown-container">
		<div class="check-in-inner">
			Countdown to Next Check-In:
		</div>
		<div class="check-in-inner" id='countdown{{ al.alert_id }}' style="color: red;">
		</div>
	</div>
	{% endif %}
	<button id="edit_alert{{ al.alert_id }}">
	Edit Alert
	</button>

</div>

<!--#########################################--> 

<!-- <div {% if al.active == False %} class="hidden" {% endif %} id="alertDiv{{ al.alert_id }}" style="border-style: solid;">
	<p>Alert: {{ al.a_name }}</p>
	{% if al.active == true %}
	<p>Currently Active</p>
	{% if al.interval %}
	<p>Checked in {{ al.checked_in }} Times so Far</p>
	{% endif %}
	{% else %}
	<p>Alert Time Passed, Alert Sent</p>
	{% endif %}
	<p id="datetime{{ al.alert_id }}">Next Alert Time: 			
	{% if al.active == True %}
	{{ al.next_alarm_dis }}
	{% endif %}
	</p>
	<p>Countdown To Alert: </p>
	<divclass="col-6" id='countdown{{ al.alert_id }}' style="display: inline-block; font-family: 'Bitter', serif; font-weight: bold; font-size: 105%; color: red;">
	</div>
</div> -->


<!-- <div class="container-fluid centered">
	<div class="row.alert_display" style="width:100%">
		<div class="col-2" style="display: inline-block; font-family: 'Bitter', serif;
        font-weight: bold; font-size: 135%;">
			<button id="edit_alert{{ al.alert_id }}">
			{{ al.a_name }}
			</button>
	
		</div>
		<div class="col-2" id="alert_inner" style="display: inline-block;"> 
			<input id="toggle_rec{{ al.alert_id }}" type="checkbox" data-toggle="toggle" class="display_toggle" data-on="Alert Set Active" data-off="Inactive" {% if al.active == True %}checked{% endif %} name="{{ al.alert_id }}">
		</div>
		

		<div class="col-6.alert_display" id="count_display{{ al.alert_id }}" style="display: inline-block; padding: 0 0 0 0;" name="{{ al.alert_id }}">
			
			<div class="col-5" id="al_time{{ al.alert_id }}" style="display: inline-block;">	
			<p id="datetime{{ al.alert_id }}" style="font-family: 'Bitter', serif;
        	font-weight: bold; font-size: 105%; color: red; display: inline-block;">
			{% if al.active == True %}
			{{ al.next_alarm_dis }}
			{% endif %}
			</p>
			</div>
		

			<div class="col-6"  id='countdown{{ al.alert_id }}' style="display: inline-block;font-family: 'Bitter', serif;
        font-weight: bold; font-size: 105%; color: red;">

			</div>
		</div>
		<div class='col-1'style="display: inline-block;" id="checked{{ al.alert_id }}">
			<p {% if al.active == False %} class='hidden' {% else %} class='visible' {%endif%}  id="checked{{ al.alert_id }}" style="font-family: 'Bitter', serif; font-weight: bold; font-size: 150%; {% if al.checked_in %} color: green; {% else %} color: red; {% endif %}">
			{% if al.checked_in == True %}
			Yes
			{% else %}
			No
			{% endif %}
			
			</p>
		</div> -->
			

<!-- </div> -->

<div id="edit_alert_modal{{ al.alert_id }}" class="modal">
    <div class="modal-content">
        <span id="close{{ al.alert_id }}">&times;</span>
        <h1 style="text-align: center;">{{ al.a_name }}</h1>

        {% if contacts|length < 1 %}
        <h5><a href="/contacts">You must add at least one contact to save an alarm set. Click here to add/edit contacts.</a></h5>
        {% endif %}
        <form name="save_alert_form{{ al.alert_id }}" id="save_alert_form{{ al.alert_id }}" action="/save_alert/{{ al.alert_id }}" onsubmit="event.preventDefault(); validateForm(save_alert_form{{ al.alert_id }})" method="POST">
            <b>What would you like to name this alert set???:</b> <input type=textbox name='a_name' value='{{ al.a_name }}'></input><br>
            <b>Where are you going and/or what are you doing that you might need this alert?</b><br>
            <textarea rows="2" cols="50" name="descri" value='{{ al.message }}'></textarea>
            <br>

            <a href="/contacts">Add/Edit/View Your Contacts</a>
            <!-- What Date would you like this alert set to first be available? (optional)<input type="date" name="date" value=""><br>
            What is the last date you would like this alert set to be available? (optional)<input type="date" name="end_date" value=""> -->
            <br><br>
            What time would you like the app to send an alert if you don't check-in by that time (your first alert)? <input type="time" name="time" value='{{ al.time }}'>
            <br>
            Which contact(s) would you like to be alerted if you miss a check-in? (select up to 3)
            <br>
            {% for contact in contacts %}
		    {% set contactloop = loop %}
		    <input type="checkbox" name="contact" value="{{ contact.contact_id }}" {% if contact.contact_id == al.contact_id1 or contact.contact_id == al.contact_id2 or contact.contact_id == al.contact_id3%}checked{% endif %}>{{ contact.name }} &nbsp &nbsp
		    {% endfor %}<br><br>
            <b>How often (in minutes) would you like to require checking in with the app after the first alert? (leave blank for a one-time alert):</b> 
	            <input type="number" name="interval" placeholder="120" min="45" max="1500" value='{{ al.interval }}'><br> 
	            (You'll receive texts reminding you to check in 30 and 15 minutes before your required check-ins)<br><br>
            <button id="save_al_submit{{ al.alert_id }}" type="submit">
            	Save Alert
            </button>
        </form>
        <form action="/delete_alert/{{ al.alert_id }}" method="POST">    
	        <button id="delete_alert{{ al.alert_id }}" type="submit">
	        	Delete Alert
	        </button>
    	</form>
        <br>
        <a href="/sw_main">Go Back to the Main SafeWalk <br> Alerts Page</a>
    

    </div>
</div>

<script type="text/javascript">
	var modal{{ al.alert_id }} = document.getElementById("edit_alert_modal{{ al.alert_id }}");
	// Get the button that opens the modal
	var btn{{ al.alert_id }} = document.getElementById("edit_alert{{ al.alert_id }}");
	// Get the <span> element that closes the modal
	var span{{ al.alert_id }} = document.getElementById("close{{ al.alert_id }}");
	// When the user clicks on the button, open the modal
	btn{{ al.alert_id }}.onclick = function() {
	modal{{ al.alert_id }}.style.display = "block";
	}
	// When the user clicks on <span> (x), close the modal
	span{{ al.alert_id }}.onclick = function() {
	modal{{ al.alert_id }}.style.display = "none";
	console.log("Modal Specific Span close triggered.")
	}

var t{{ al.alert_id }} = ({{ al.total }} * 1000)

$(document).ready( function() {

  function count{{ al.alert_id }}(change = 0) {
      t{{ al.alert_id }} = (t{{ al.alert_id }} - 1000);
      var t = t{{ al.alert_id }};
      var seconds = Math.floor( (t/1000) % 60 );
      var minutes = Math.floor( (t/1000/60) % 60 );
      var hours = Math.floor( (t/(1000*60*60)) % 24 );
      var days = Math.floor( t/(1000*60*60*24) );


    if (seconds < 10) {
    // Add the "0" digit to the front
    // so 9 becomes "09"
    seconds = "0" + seconds;
    }

    if (minutes < 10) {
    // Add the "0" digit to the front
    // so 9 becomes "09"
    minutes = "0" + minutes;
    
    }

    // This gets a "handle" to the clock div in our HTML
    var countDiv = document.getElementById('countdown{{ al.alert_id }}');

    // Then we set the text inside the clock div 
    // to the hours, minutes, and seconds of the current time

    if(t > 0) {
    countDiv.innerText = days + " days & " + hours + ":" + minutes + ":" + seconds + " Remaining";
  
    return {
        'changes': change + 1 
    };
    }
    else {
    countDiv.innerText = "0 days and 0:00:00 Remaining";
  
    return {
        'changes': change 
    };

    }

  }

  // This runs the displayTime function the first time
  var changing = count{{ al.alert_id }}().changes;

  count{{ al.alert_id }}(changing);  
  setInterval(count{{ al.alert_id }}, 1000);

});

alertDiv{{ al.alert_id }}
$(document).ready(function(){
    $( "#toggle_rec{{ al.alert_id }}" ).change(function(event){
    	console.log('Toggle is pressed!');
    });
});

$(document).ready(function(){
    $( "#toggle_rec{{ al.alert_id }}" ).change(function(event){
        console.log('Button is pressed!')
        if(this.checked) {
            $.get("/activate/{{ al.alert_id }}", function(data) {
                document.getElementById("datetime{{ al.alert_id }}").innerHTML = data;
                console.log("data then value:");
                console.log(data);
                console.log(data.value);
            });
            console.log("Toggle Button On is working");
            $( "#alertDiv{{ al.alert_id }}" ).removeClass("hidden").addClass("col-6");
            $( "#alertDiv{{ al.alert_id }}" ).show();
        }
        else {
            $.get("/deactivate/{{ al.alert_id }}");
            console.log("Toggle Button Off is working");
            $( "#count_display{{ al.alert_id }}" ).hide();
            $( "#countdown{{ al.alert_id }}").hide();
            $( "#checked{{ al.alert_id }}").hide()
        };
    
	});
});

</script>

{% endfor %}
<script type="text/javascript">
	document.querySelectorAll('.display_toggle').forEach(item => {
	  item.addEventListener('click', event => {
	    //handle click
	    
	  })
	})
</script>
<!--#########################################-->

<div class="centered_text">
<button id="add_new_alert" type="button" class="centered">
	Add New Alert
</button>
</div>
<div id="new_alert_modal" class="modal" style="color:black">
    <div class="modal-content">
        <span id="closeO">&times;</span>
        <h1 style="text-align: center;">New Alert</h1>

        {% if contacts|length < 1 %}
        <h5><a href="/contacts">You must add at least one contact to save an alarm set. Click here to add/edit contacts.</a></h5>
        {% endif %}
        <form name="add_alert_form" id="add_alert_form" action="/add_alert" onsubmit="event.preventDefault(); validateForm(add_alert_form)" method="POST">
            <b>What would you like to name this alert set???:</b> <input type=textbox name='a_name'></input><br>
            <b>Where are you going and/or what are you doing that you might need this alert?</b><br>
            <textarea rows="2" cols="50" name="descri"></textarea>
            <br>

            <a href="/contacts">Add/Edit/View Your Contacts</a>
            <!-- What Date would you like this alert set to first be available? (optional)<input type="date" name="date" value=""><br>
            What is the last date you would like this alert set to be available? (optional)<input type="date" name="end_date" value=""> -->
            <br><br>
            What time would you like the app to send an alert if you don't check-in by that time (your first alert)? <input type="time" name="time">
            <br>
            Which contact(s) would you like to be alerted if you miss a check-in? (select up to 3)
            <br>
            {% for contact in contacts %}
            {% set contactloop = loop %}
            <input type="checkbox" name="contact" value="{{ contact.contact_id }}">{{ contact.name }} &nbsp &nbsp
            {% endfor %}<br><br>
            <b>How often (in minutes) would you like to require checking in with the app after the first alert? (leave blank for a one-time alert):</b> 
	            <input type="number" name="interval" placeholder="120" min="45" max="1500"><br> 
	            (You'll receive texts reminding you to check in 30 and 15 minutes before your required check-ins)<br><br>
            <button id="new_alert_submit" type="submit">
            	Create Alert
            </button>
            <br>
            <a href="/sw_main">Go Back to the Main SafeWalk <br> Alerts Page</a>
        </form>

    </div>
</div>
</div>
<!--#########################################-->



<script type="text/javascript">
	$(document).ready( function() {
	  function displayTime() {
	    var currentTime = new Date();
		var year = currentTime.getYear() + 1900;
	    var month = currentTime.getMonth() + 1;
	    var day = currentTime.getDate();
	    
	    
	    var hours = currentTime.getUTCHours() + 1;
	    var minutes = currentTime.getMinutes();
	    var seconds = currentTime.getSeconds();
	    var meridiem = "AM";
	    hours = hours + {{ timezone }};
	    if (hours < 0) {
	    	hours = 24 + hours
	    }
	    if (hours > 12) {
		    hours = hours - 12;
		    meridiem = "PM";
		}

		// 0 AM and 0 PM should read as 12
		if (hours === 0) {
		    hours = 12;    
		}

	    if (seconds < 10) {
	    // Add the "0" digit to the front
	    // so 9 becomes "09"
	    seconds = "0" + seconds;
		}

		if (minutes < 10) {
	    // Add the "0" digit to the front
	    // so 9 becomes "09"
	    minutes = "0" + minutes;
		}

	    // This gets a "handle" to the clock div in our HTML
	    var clockDiv = document.getElementById('clock');

	    // Then we set the text inside the clock div 
	    // to the hours, minutes, and seconds of the current time
	    clockDiv.innerText =  hours + ":" + minutes + ":" + seconds + " " + meridiem + ",    " + month + "/" + day + "/" + year;
	  }

	  // This runs the displayTime function the first time
	  displayTime();
	  setInterval(displayTime, 1000);

	});






	// code from https://www.w3schools.com/howto/howto_css_modals.asp//
	// Get the modal
	var modal = document.getElementById("new_alert_modal");

	// Get the button that opens the modal
	var btn = document.getElementById("add_new_alert");
	// Get the <span> element that closes the modal
	var span = document.getElementById("closeO");
	// When the user clicks on the button, open the modal
	btn.onclick = function() {
		modal.style.display = "block";
	}
	// When the user clicks on <span> (x), close the modal
	span.onclick = function() {
		modal.style.display = "none";
		console.log("New Alert Span close triggered.");
	}
	// When the user clicks anywhere outside of the modal, close it

	function validateForm(form) {
	  let formName = form.name;
	  console.log("ValidateForm triggered, Formname: ", formName)
	  let x = document.forms[formName]["time"].value;
	  let y = document.forms[formName]["interval"].value;
	  if (x == "" && y == "") {
	    alert("A scheduled time or an interval between check-ins is required to save alert.");
	    return false;
	  } else {
	  	console.log("Else in Validate form triggered!")
	  	document.getElementById(formName).submit();
	  }
	}


{% for al in alerts %}

{% endfor %}

	// function addingSet(){
	// 	console.log('Button is pressed!');	
	// 	console.log('Form Data: ')
	// 	$.post("/add_schedset", $("#add_sched_form").serialize(), function(data) {
	// 		console.log("data then value:");
	// 		console.log(data);
	// 		$('input[name="alertsetID"]').val(data);
	// 		console.log(data.value);
	// 	});
	// };
	// function addingAlert(){
	// 	console.log('Button is pressed!');	
	// 	console.log('Form Data: ')
	// 	path = "/add_alert/" + ($('[name=alertsetID]').val())
	// 	$.post(path, $("#set_form").serialize(), function(data) {
	// 		console.log("data then value:");
	// 		console.log(data);
	// 		$('input[name="alertsetID"]').val(parseInt(data));
	// 		console.log(data.value);
	// 	});
	// };
</script>
{% endblock %}